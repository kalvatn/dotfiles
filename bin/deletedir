#!/bin/bash

export LOGLEVEL=INFO
source "$HOME/.functions"

if [ -z "$1" ]; then
  error "missing directory argument"
  exit 1
fi

dir="$(readlink -f "$1")"

if [ -z "$dir" ]; then
  error "directory $1 does not exist"
  exit 1
fi

if [ ! -d "$dir" ]; then
  error "directory $dir does not exist"
  exit 1
fi

info "finding inode count for $dir"
find "$dir" -xdev -printf '%h\n' | sort | uniq -c | sort -k 1 -n

time {
  info "deleting all files in all subdirectories of $dir"
  find "$dir" -maxdepth 1 -type d -exec find {} -type f -delete \;

  info "removing leftover empty directories in $dir"
  find "$dir" -type d -empty -delete
}
